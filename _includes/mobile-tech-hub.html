<section id="rbx-mobile-tech-hub" class="rbx-mobile-tech-hub{% if include.mobile_only %} rbx-monly{% endif %}" aria-label="Explore by technology">
  <div class="rbx-mth-shell">
    <!-- Left: Tag Ribbon -->
    <nav class="rbx-mth-tags" aria-label="Tags"></nav>

    <!-- Right: Content Pane -->
    <div class="rbx-mth-pane">
      <div class="rbx-mth-tabs" role="tablist" aria-label="Post filter">
        <button class="rbx-mth-tab" role="tab" aria-selected="false" data-view="featured">
          Featured Posts
        </button>
        <button class="rbx-mth-tab is-active" role="tab" aria-selected="true" data-view="all">
          All Posts
        </button>
      </div>

      <div class="rbx-mth-list" role="region" aria-live="polite" aria-busy="false">
        <div class="rbx-mth-empty" hidden>No posts yet.</div>
      </div>
    </div>
  </div>

  <!-- Data seed -->
  <script type="application/json" id="rbx-mth-data">
  {
    "posts": [
      {% assign all_posts = site.posts | where_exp: "p","p.draft != true" %}
      {% for p in all_posts %}
        {
          "title": {{ p.title | jsonify }},
          "url": {{ p.url | relative_url | jsonify }},
          "date": {{ p.date | date: "%Y-%m-%d" | jsonify }},
          "excerpt": {{ p.excerpt | strip_html | strip_newlines | truncate: 160 | jsonify }},
          "featured": {{ p.featured | default: false | jsonify }},
          "tags": [{% for t in p.tags %}{{ t | jsonify }}{% unless forloop.last %},{% endunless %}{% endfor %}],
          "thumb": {% if p.image %}{{ p.image | relative_url | jsonify }}{% else %}null{% endif %}
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ]
  }
  </script>

  <!-- Controller (scoped) -->
  <script>
  (function(){
    const root = document.currentScript.closest('#rbx-mobile-tech-hub');
    if(!root) return;

    const payload = JSON.parse(root.querySelector('#rbx-mth-data').textContent.trim());
    const POSTS = (payload.posts || []).map(p => ({
      ...p,
      _tags: (p.tags || []).map(t => String(t).toLowerCase())
    }));

    const tagsNav = root.querySelector('.rbx-mth-tags');
    const tabsEl  = root.querySelector('.rbx-mth-tabs');
    const listEl  = root.querySelector('.rbx-mth-list');
    const emptyEl = root.querySelector('.rbx-mth-empty');

    let currentTag = null;
    let currentView = 'all'; // default to All so first paint isn't blank

    function setActiveTag(btn){
      tagsNav.querySelectorAll('.rbx-mth-tag').forEach(b=>b.classList.remove('is-active'));
      if(btn){ btn.classList.add('is-active'); currentTag = btn.dataset.tag; }
    }
    function setActiveTab(tabBtn){
      tabsEl.querySelectorAll('.rbx-mth-tab').forEach(t=>{
        t.classList.remove('is-active');
        t.setAttribute('aria-selected','false');
      });
      tabBtn.classList.add('is-active');
      tabBtn.setAttribute('aria-selected','true');
      currentView = tabBtn.dataset.view;
    }
    function filterPosts(){
      let items = POSTS;
      if(currentTag){ items = items.filter(p => (p._tags || []).includes(currentTag)); }
      if(currentView === 'featured'){ items = items.filter(p => !!p.featured); }
      return items;
    }
    function render(){
      const items = filterPosts();
      listEl.innerHTML = '';
      emptyEl.hidden = items.length > 0;

      // If user is on Featured but nothing to show, auto-flip to All
      if(currentView === 'featured' && items.length === 0){
        const allBtn = root.querySelector('.rbx-mth-tab[data-view="all"]');
        if(allBtn){ setActiveTab(allBtn); return render(); }
      }

      for(const p of items){
        const a = document.createElement('a');
        a.href = p.url;
        a.className = 'rbx-mth-card';

        const img = document.createElement('img');
        img.className = 'rbx-mth-thumb';
        img.loading = 'lazy';
        img.alt = '';
        if(p.thumb){ img.src = p.thumb; }

        const box = document.createElement('div');
        const h4 = document.createElement('h4'); h4.textContent = p.title;
        const meta = document.createElement('div'); meta.className = 'rbx-mth-meta'; meta.textContent = p.date || '';

        box.appendChild(h4); box.appendChild(meta);
        a.appendChild(img); a.appendChild(box);
        listEl.appendChild(a);
      }
      listEl.setAttribute('aria-busy','false');
    }

    // Build tag map: { tag -> count }, lowercase & dedup
    function buildTagMap(){
      const map = new Map();
      for(const p of POSTS){
        const uniq = Array.from(new Set(p._tags || []));
        for(const t of uniq){
          map.set(t, (map.get(t) || 0) + 1); // <-- fixed +
        }
      }
      return map;
    }

    // Render the left ribbon from the map
    function renderTags(){
      const map = buildTagMap();
      const entries = Array.from(map.entries())
        .sort((a,b) => a[0].localeCompare(b[0])); // alpha; change to (b[1]-a[1]) for count desc
      const frag = document.createDocumentFragment();
      for(const [tag, count] of entries){
        const btn = document.createElement('button');
        btn.className = 'rbx-mth-tag';
        btn.dataset.tag = tag;
        btn.innerHTML =
          `<span class="rbx-mth-tag-label">${tag}</span>
           <span class="rbx-mth-tag-count">${count}</span>`;
        frag.appendChild(btn);
      }
      tagsNav.innerHTML = '';
      tagsNav.appendChild(frag);
    }

    // First render
    renderTags();
    const firstTagBtn = tagsNav.querySelector('.rbx-mth-tag');
    if(firstTagBtn){ setActiveTag(firstTagBtn); }

    tagsNav.addEventListener('click', (e)=>{
      const btn = e.target.closest('.rbx-mth-tag'); if(!btn) return;
      setActiveTag(btn); listEl.setAttribute('aria-busy','true'); render();
    });
    tabsEl.addEventListener('click', (e)=>{
      const t = e.target.closest('.rbx-mth-tab'); if(!t) return;
      setActiveTab(t); listEl.setAttribute('aria-busy','true'); render();
    });

    render();
  })();
  </script>
</section>